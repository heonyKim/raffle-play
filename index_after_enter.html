<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Í≤ΩÌíà Ï∂îÏ≤®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css"
    />
    <style>
      * {
        font-family: "Pretendard Variable", sans-serif;
      }
      .setting_container {
        margin: 10px;
        padding: 10px;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        border: 1px solid #dadee3;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
        width: 400px;
        height: calc(100% - 60px);
      }
      #ball_container {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        width: 100%;
        max-width: calc(100%);
        justify-content: flex-start;
        align-items: flex-start;
      }
      .ball_wrap {
        background-color: black;
        margin: 10px;
        padding: 10px;
        border-radius: 10px;

        border: 1px solid #dadee3;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);

        width: 100%;
        max-width: calc(100%);
        justify-content: flex-start;
        align-items: flex-start;
        height: calc(100% - 20px);
      }
      .primary-color {
        color: white;
        background-color: #619eff;
      }
      .button-default {
        border-radius: 5px;
        background-color: #dadee3;
        padding: 8px 10px;
        font-size: 22pt;
        font-weight: bold;
      }
      .button-outline {
        border: 1px solid #619eff;
        background-color: white;
        color: #619eff;
      }
      .button-selected {
        background-color: #619eff;
        color: white;
      }

      .ball {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 1px solid #394452;
        background: radial-gradient(circle at 30% 30%, #ffffff, #dbe0e6);
        box-shadow: inset -3px -3px 8px rgba(255, 255, 255, 0.6),
          inset 3px 3px 8px rgba(0, 0, 0, 0.1), 0 4px 8px rgba(0, 0, 0, 0.2);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 32px;
        color: #394452;
        font-weight: bold;
      }
      .ball_selected {
        background: #619eff;
        box-shadow: none;
        color: white;
      }
      .ball_completed {
        background: #619eff;
        box-shadow: none;
        color: white;
      }
      #prizeList {
        height: -webkit-fill-available;
        overflow-y: auto;
      }
      .special {
        background-color: #feab29;
        color: white;
      }
      .button-selected.special {
        border: 5px solid #619eff;
        color: white;
      }
    </style>
  </head>
  <body class="flex h-screen overflow-hidden bg-gray-50">
    <!-- ÏôºÏ™Ω ÏòÅÏó≠: ÏÉÅÌíà Î∞è ÏÑ§Ï†ï -->
    <div class="h-full">
      <div class="setting_container">
        <h2
          id="titleArea"
          contenteditable
          class="items-center text-2xl font-bold mb-4 cursor-pointer text-[#619eff]"
        >
          Ï†úÎ™© ÏûÖÎ†•
        </h2>
        <div id="prizeList" class="grid grid-cols-2 gap-2 w-full"></div>
        <div>
          <textarea
            id="probabilityFunction"
            class="w-full h-32 border p-2 mt-4"
          >
  function getRandom(numbers){
      return Math.floor(Math.random() * (200 - 100 + 1)) + 100;
  }
          </textarea>
          <input
            id="ballCount"
            type="number"
            class="border p-2 w-full mt-2"
            placeholder="Î∞úÍ∏âÏà´Ïûê ÏûÖÎ†• ÌõÑ Enter"
          />
          <div style="display: flex; gap: 10px; width: 100%">
            <button
              id="addPrizeBtn"
              class="px-3 py-1 bg-blue-500 text-white rounded mt-2 h-[48px]"
              style="flex: 1"
            >
              + ÏÉÅÌíà Ï∂îÍ∞Ä
            </button>
            <button
              id="resetPrizeBtn"
              class="bg-red-500 text-white rounded mt-2 h-[48px]"
              style="flex: 1"
            >
              Î¶¨ÏÖã
            </button>
          </div>
          <div style="display: flex; gap: 10px; width: 100%">
            <button
              id="drawBtn"
              class="px-4 py-2 primary-color text-white rounded mt-2 h-[48px]"
              style="flex: 2"
            >
              Ï∂îÏ≤®!
            </button>
          </div>
        </div>
      </div>
      <div class="max-w-7xl mx-auto px-4 text-center">
        <p class="text-sm">
          ¬© 2025
          <a
            href="https://github.com/heonyKim"
            class="text-blue-400 hover:underline"
            target="_blank"
          >
            heonyKim </a
          >.
          <a
                  href="https://github.com/shjeon-96"
                  class="text-blue-400 hover:underline"
                  target="_blank"
          >
            shjeon-96 </a
          >.
          All rights reserved.
        </p>
      </div>
    </div>

    <!-- Ïò§Î•∏Ï™Ω ÏòÅÏó≠: Ï∫îÎ≤ÑÏä§ -->
    <div class="w-full h-full flex items-center justify-center">
      <div class="ball_wrap">
        <div id="ball_container" />
      </div>
    </div>

    <script type="module">
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      let drawAfterEnterAudioBuffer = null;

      // const sound = new Audio('733769__slv443__click-menu.wav');
      // const track = audioCtx.createMediaElementSource(sound);

      fetch('733769__slv443__click-menu.wav')
              .then(response => response.arrayBuffer())
              .then(arrayBuffer => audioCtx.decodeAudioData(arrayBuffer))
              .then(decodedData => {
                drawAfterEnterAudioBuffer = decodedData;
                console.log("WAV ÌååÏùºÏù¥ Î°úÎìúÎêòÏóàÏäµÎãàÎã§.");
              })
              .catch(error => {
                console.error("Ïò§ÎîîÏò§ Î°úÎìú ÏóêÎü¨:", error);
              });



      let balls = [];
      let selectedPrize = null;
      let drawStatus = 0;
      let latestTitleArea = localStorage.getItem("latestTitleArea");
      let titleArea = document.getElementById("titleArea");
      if (!latestTitleArea) {
        latestTitleArea = titleArea.innerText;
      }
      titleArea.innerText = latestTitleArea;

      const latestPrizeList = localStorage.getItem("latestPrizeList");
      if (latestPrizeList) {
        const targetDiv = document.getElementById("prizeList");
        targetDiv.innerHTML = latestPrizeList;
        const buttons = document.querySelectorAll("#prizeList button");
        buttons.forEach((button) => {
          button.classList.remove("button-selected");
          button.onclick = () => {
            [...prizeList.children].forEach((c) =>
              c.classList.remove("button-selected")
            );
            button.classList.add("button-selected");
            selectedPrize = button;
          };
        });
      }

      const latestBallCount = localStorage.getItem("latestBallCount");
      if (latestBallCount) {
        document.getElementById("ballCount").value = latestBallCount;
        // createBalls(+latestBallCount);
      }

      const latestBalls = localStorage.getItem("latestBalls");
      if (latestBalls) {
        setBalls(JSON.parse(latestBalls));
      }

      // Í≥µ ÏÉùÏÑ± (Î∞úÍ∏âÏà´Ïûê ÏûÖÎ†• ÌõÑ ÏóîÌÑ∞)
      document.getElementById("ballCount").onkeyup = (e) => {
        if (e.key === "Enter") createBalls(+e.target.value);
      };

      // Î∞∞Ïó¥ ÏÑûÍ∏∞ (Fisher-Yates ÏïåÍ≥†Î¶¨Ï¶ò)
      function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      // Í≥µ ÏÉùÏÑ± Ìï®Ïàò
      function createBalls(n) {

        setBalls(
                shuffle(Array.from({ length: n }, (_, i) => i + 1))
        );

      }

      // Í≥µ Îì±Î°ù Ìï®Ïàò
      function setBalls(targetBalls) {
        balls = targetBalls;

        const ballContainer = document.getElementById("ball_container");
        ballContainer.innerHTML = ""; // Ï¥àÍ∏∞Ìôî (ÌïÑÏöî Ïãú)

        const ballsArray = targetBalls.map((item) => {
          const ball = document.createElement("div");
          ball.classList.add("ball");
          ball.textContent = item;
          return ball;
        });

        ballsArray.forEach((ball) => {
          ballContainer.appendChild(ball);
        });

        localStorage.setItem("latestBallCount", targetBalls.length);
        localStorage.setItem("latestBalls", JSON.stringify(targetBalls));
      }

      function preventRefresh(e) {
        // F5 ÌÇ§ (ÌÇ§ ÏΩîÎìú 116) ÎßâÍ∏∞
        if (e.keyCode === 116) {
          e.preventDefault();
          alert("Ï∂îÏ≤® Ï§ë ÏÉàÎ°úÍ≥†Ïπ®Ïù¥ Ï†úÌïúÎê©ÎãàÎã§.");
        } else if ((e.ctrlKey || e.metaKey) && e.keyCode === 82) {
          // Ctrl+R ÌòπÏùÄ Command+R (mac) ÎßâÍ∏∞
          e.preventDefault();
          alert("Ï∂îÏ≤® Ï§ë ÏÉàÎ°úÍ≥†Ïπ®Ïù¥ Ï†úÌïúÎê©ÎãàÎã§.");
        }
        window.onbeforeunload = function (e) {
          e.preventDefault();
        };
      }

      // Ï∂îÏ≤® Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
      document.getElementById("drawBtn").onclick = () => {
        console.log("drawStatus", drawStatus);
        if (drawStatus > 0)
          return Swal.fire({
            title: "Ï∂îÏ≤®Ïù¥ ÏßÑÌñâÏ§ë ÏûÖÎãàÎã§.",
            width: "auto",
            padding: "1em",
            heightAuto: false,
            allowOutsideClick: false,
            confirmButtonText: "ÌôïÏù∏",
            customClass: {
              confirmButton: "primary-color", // Ïó¨Í∏∞ÏÑú Ïª§Ïä§ÌÖÄ ÌÅ¥ÎûòÏä§ ÏßÄÏ†ï
            },
          });
        if (!selectedPrize)
          return Swal.fire({
            title: "ÏÉÅÌíàÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî",
            width: "auto",
            padding: "1em",
            heightAuto: false,
            allowOutsideClick: false,
            confirmButtonText: "ÌôïÏù∏",
            customClass: {
              confirmButton: "primary-color", // Ïó¨Í∏∞ÏÑú Ïª§Ïä§ÌÖÄ ÌÅ¥ÎûòÏä§ ÏßÄÏ†ï
            },
          });
        if (balls.length === 0)
          return Swal.fire({
            title: "Î∞úÍ∏âÎêú Î≤àÌò∏Í∞Ä Î™®Îëê ÏÇ¨Ïö©ÎêòÏóàÏäµÎãàÎã§.",
            width: "auto",
            padding: "1em",
            heightAuto: false,
            allowOutsideClick: false,
            confirmButtonText: "ÌôïÏù∏",
            customClass: {
              confirmButton: "primary-color", // Ïó¨Í∏∞ÏÑú Ïª§Ïä§ÌÖÄ ÌÅ¥ÎûòÏä§ ÏßÄÏ†ï
            },
          });
        drawStatus = 1;

        // ÏÉàÎ°úÍ≥†Ïπ® Ï†úÌïú
        document.addEventListener("keydown", preventRefresh);
        const ballsArray = document.querySelectorAll(".ball");
        let currentIteration = 0;
        // 10ms Í∞ÑÍ≤©ÏúºÎ°ú Î¨¥Ìïú ÏßÑÌñâÎêòÎäî Îπ†Î•∏ ÌïòÏù¥ÎùºÏù¥Ìä∏ Ïï†ÎãàÎ©îÏù¥ÏÖò
        let fastInterval = setInterval(() => {
          let highlightIndex = currentIteration % balls.length;

          currentIteration++;

          // div ball Ïï†ÎãàÎ©îÏù¥ÏÖò
          ballsArray.forEach((ball) => ball.classList.remove("ball_selected"));
          ballsArray[highlightIndex].classList.add("ball_selected");
        }, 30);

        // ÏóîÌÑ∞ÌÇ§ ÏûÖÎ†• Ïãú Îπ†Î•∏ Ïï†ÎãàÎ©îÏù¥ÏÖò Ï§ëÎã® Î∞è spinCount Í≤∞Ï†ï ÌõÑ ÎäêÎ¶∞ Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
        const enterHandler = (e) => {
          e.preventDefault();
          drawStatus = 2;
          let intervalDuration = 50;
          let highlightIndex;
          if (e.key === "Enter") {
            clearInterval(fastInterval);
            document.removeEventListener("keydown", enterHandler);

            // ÌôïÎ•† Ìï®ÏàòÏóê Îî∞Îùº Ï∂îÍ∞Ä spinCount Í≤∞Ï†ï
            let getRandom = eval(
              `(${document.getElementById("probabilityFunction").value})`
            );
            let randomIdx = getRandom(balls.length);
            let additionalSpinCount = randomIdx + 1;
            let targetSpinCount = currentIteration + additionalSpinCount;
            console.log("Target spin count:", targetSpinCount);

            // ÎäêÎ†§ÏßÄÎäî Ïï†ÎãàÎ©îÏù¥ÏÖò Îã®Í≥ÑÎ≥Ñ Ïã§Ìñâ (ÏõêÎûò Î°úÏßÅÍ≥º ÎèôÏùº)
            // startSecondInterval();

            startAnimation();

            function startAnimation() {
              function animateStep() {
                highlightIndex = currentIteration % balls.length;
                // div ball Ïï†ÎãàÎ©îÏù¥ÏÖò
                ballsArray.forEach((ball) =>
                  ball.classList.remove("ball_selected")
                );
                ballsArray[highlightIndex].classList.add("ball_selected");

                currentIteration++;
                const gap = targetSpinCount - currentIteration;
                console.log("Interval, remaining:", gap, intervalDuration);

                if (drawAfterEnterAudioBuffer) {
                  // AudioBufferSourceNodeÎäî Ìïú Î≤à Ïû¨ÏÉù ÌõÑ Ïû¨ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏúºÎØÄÎ°ú Îß§Î≤à ÏÉàÎ°ú ÏÉùÏÑ±Ìï¥Ïïº Ìï©ÎãàÎã§.
                  const source = audioCtx.createBufferSource();
                  source.buffer = drawAfterEnterAudioBuffer;
                  source.connect(audioCtx.destination);
                  source.start();
                }

                // if (track) {
                //   track.connect(audioCtx.destination);
                //   source.start();
                // }

                setIntervalDuration(gap);

                if (currentIteration >= targetSpinCount) {
                  endAnimation();
                  return;
                }

                setTimeout(animateStep, intervalDuration);
              }

              animateStep(); // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
            }

            function setIntervalDuration(gap) {
              if (gap <= 1) {
                intervalDuration = 1000;
              } else if (gap <= 3) {
                intervalDuration = 900;
              } else if (gap <= 7) {
                intervalDuration = 700;
              } else if (gap <= 12) {
                intervalDuration = 500;
              } else if (gap <= 25) {
                intervalDuration = 300;
              }  else if (gap <= 50) {
                intervalDuration = 100;
              } else {
                intervalDuration = 50;
              }
            }

            function endAnimation() {
              // ÏµúÏ¢Ö ÎãπÏ≤® Í≥µ Ï≤òÎ¶¨
              let winnerBall = ballsArray[highlightIndex];
              winnerBall.active = true;
              setTimeout(() => {
                // div ball Ïï†ÎãàÎ©îÏù¥ÏÖò
                ballsArray.forEach((ball) =>
                  ball.classList.remove("ball_selected")
                );
                winnerBall.classList.add("ball_completed");
              }, 1000);
              setTimeout(() => {
                drawStatus = 0;
                balls.splice(highlightIndex, 1);

                Swal.fire({
                  title: `${winnerBall.textContent}Î≤à`,
                  html: `üéâ <strong>Ï∂ïÌïòÌï©ÎãàÎã§!</strong> ${selectedPrize.textContent} ÎãπÏ≤®!`,
                  icon: "success",
                  iconHtml: `üéâ`, // Ï≤¥ÌÅ¨ÌëúÏãú ÎåÄÏã† Îã§Î•∏ Î¨∏Ïûê ÎÑ£Í∏∞
                  width: "auto",
                  padding: "1em",
                  heightAuto: false,
                  allowOutsideClick: false,
                  showConfirmButton: true,
                  confirmButtonText: "ÌôïÏù∏",
                  buttonsStyling: true,
                  customClass: {
                    confirmButton: "primary-color", // Ïó¨Í∏∞ÏÑú Ïª§Ïä§ÌÖÄ ÌÅ¥ÎûòÏä§ ÏßÄÏ†ï
                  },
                }).then(() => {
                  // ÎãπÏ≤®Îêú Î≤àÌò∏Îäî ballArrayÏóêÏÑú Ï†úÍ±∞
                  ballsArray[highlightIndex].remove();
                });

                selectedPrize.textContent += ` - ${winnerBall.textContent}Î≤à`;
                // selectedPrize.disabled = true;
                selectedPrize.classList.add("button-outline");
                selectedPrize = null;
                [...prizeList.children].forEach((c) =>
                  c.classList.remove("bg-green-400")
                );
                localStorage.setItem("latestPrizeList", prizeList.innerHTML);
                localStorage.setItem("latestBalls", JSON.stringify(balls));
                document.removeEventListener("keydown", preventRefresh);
              }, 1500);
            }
          }
        };

        document.addEventListener("keydown", enterHandler);
      };

      // ÏÉÅÌíà Ï∂îÍ∞Ä Î≤ÑÌäº Ïù¥Î≤§Ìä∏
      document.getElementById("addPrizeBtn").onclick = () => {
        Swal.fire({
          input: "textarea",
          title: "ÏÉÅÌíàÎ™ÖÏùÑ Ï§ÑÎ∞îÍøàÏúºÎ°ú ÏûÖÎ†•",
          showCancelButton: true,
          width: "auto",
          padding: "1em",
          heightAuto: false,
          allowOutsideClick: false,
          confirmButtonText: "Ï∂îÍ∞Ä",
          cancelButtonText: "Ï∑®ÏÜå",
          customClass: {
            confirmButton: "primary-color", // Ïó¨Í∏∞ÏÑú Ïª§Ïä§ÌÖÄ ÌÅ¥ÎûòÏä§ ÏßÄÏ†ï
          },
        })
          .then(({ value }) => {
            value?.split("\n").forEach((p) => {
              const el = document.createElement("button");
              el.textContent = p;
              const defaultClass = "button-default ";

              if (p.includes("ÏÜêÏä§ÌÉÄ") || p.includes("ÌïúÏßÄÎãàÏñ¥Ïä§")) {
                el.className = defaultClass + "special";
              } else {
                el.className = defaultClass;
              }

              el.onclick = () => {
                [...prizeList.children].forEach((c) =>
                  c.classList.remove("button-selected")
                );
                el.classList.add("button-selected");
                selectedPrize = el;
              };
              prizeList.append(el);
            });
          })
          .then((value) => {
            localStorage.setItem("latestPrizeList", prizeList.innerHTML);
          });
      };

      // Î¶¨ÏÖã Î≤ÑÌäº Ïù¥Î≤§Ìä∏
      document.getElementById("resetPrizeBtn").onclick = () => {
        if (confirm("Î¶¨ÏÖãÏùÑ ÏßÑÌñâÌï©ÎãàÎã§") === true) {
          prizeList.innerHTML = "";
          ball_container.innerHTML = "";
          balls = [];
          selectedPrize = null;

          localStorage.removeItem("latestPrizeList");
          localStorage.removeItem("latestBallCount");
          localStorage.removeItem("latestBalls");

        }
      };

      titleArea.addEventListener("blur", (e) => {
        localStorage.setItem("latestTitleArea", titleArea.innerText);
      });
    </script>
  </body>
</html>
