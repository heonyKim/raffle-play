<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ê²½í’ˆ ì¶”ì²¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css"
    />
    <style>
      * {
        font-family: "Pretendard Variable", sans-serif;
      }
      .setting_container {
        margin: 10px;
        padding: 10px;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        border: 1px solid #dadee3;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
        width: 400px;
        height: calc(100% - 60px);
      }
      #ball_container {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        width: 100%;
        max-width: calc(100%);
        justify-content: flex-start;
        align-items: flex-start;
      }
      .ball_wrap {
        margin: 10px;
        padding: 10px;
        border-radius: 10px;

        border: 1px solid #dadee3;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);

        width: 100%;
        max-width: calc(100%);
        justify-content: flex-start;
        align-items: flex-start;
        height: calc(100% - 20px);
      }
      .primary-color {
        color: white;
        background-color: #619eff;
      }
      .button-default {
        border-radius: 5px;
        background-color: #dadee3;
        padding: 8px 10px;
      }
      .button-outline {
        border: 1px solid #619eff;
        background-color: white;
        color: #619eff;
      }
      .button-selected {
        background-color: #619eff;
        color: white;
      }

      .ball {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 1px solid #394452;
        background: radial-gradient(circle at 30% 30%, #ffffff, #dbe0e6);
        box-shadow: inset -3px -3px 8px rgba(255, 255, 255, 0.6),
          inset 3px 3px 8px rgba(0, 0, 0, 0.1), 0 4px 8px rgba(0, 0, 0, 0.2);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 24px;
        color: #394452;
        font-weight: bold;
      }
      .ball_selected {
        background: #619eff;
        box-shadow: none;
        color: white;
      }
      .ball_completed {
        background: #619eff;
        box-shadow: none;
        color: white;
      }
      #prizeList {
        height: -webkit-fill-available;
        overflow-y: auto;
      }
      .special {
        background-color: #feab29;
        color: white;
      }
      .button-selected.special {
        border: 5px solid #619eff;
        color: white;
      }
    </style>
  </head>
  <body class="flex h-screen overflow-hidden bg-gray-50">
    <!-- ì™¼ìª½ ì˜ì—­: ìƒí’ˆ ë° ì„¤ì • -->
    <div class="h-full">
      <div class="setting_container">
        <h2
          id="titleArea"
          contenteditable
          class="items-center text-2xl font-bold mb-4 cursor-pointer text-[#619eff]"
        >
          ì œëª© ì…ë ¥
        </h2>
        <div id="prizeList" class="grid grid-cols-2 gap-2 w-full"></div>
        <div>
          <textarea
            id="probabilityFunction"
            class="w-full h-32 border p-2 mt-4"
          >
  function getRandom(numbers){
      return Math.floor(Math.random() * (200 - 100 + 1)) + 100;
  }
          </textarea>
          <input
            id="ballCount"
            type="number"
            class="border p-2 w-full mt-2"
            placeholder="ë°œê¸‰ìˆ«ì ì…ë ¥ í›„ Enter"
          />
          <div style="display: flex; gap: 10px; width: 100%">
            <button
              id="addPrizeBtn"
              class="px-3 py-1 bg-blue-500 text-white rounded mt-2 h-[48px]"
              style="flex: 1"
            >
              + ìƒí’ˆ ì¶”ê°€
            </button>
            <button
              id="resetPrizeBtn"
              class="bg-red-500 text-white rounded mt-2 h-[48px]"
              style="flex: 1"
            >
              ë¦¬ì…‹
            </button>
          </div>
          <div style="display: flex; gap: 10px; width: 100%">
            <button
              id="drawBtn"
              class="px-4 py-2 primary-color text-white rounded mt-2 h-[48px]"
              style="flex: 2"
            >
              ì¶”ì²¨!
            </button>
          </div>
        </div>
      </div>
      <div class="max-w-7xl mx-auto px-4 text-center">
        <p class="text-sm">
          Â© 2025
          <a
            href="https://github.com/heonyKim"
            class="text-blue-400 hover:underline"
            target="_blank"
          >
            heonyKim </a
          >. All rights reserved.
        </p>
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½ ì˜ì—­: ìº”ë²„ìŠ¤ -->
    <div class="w-full h-full flex items-center justify-center">
      <div class="ball_wrap">
        <div id="ball_container" />
      </div>
    </div>

    <script type="module">
      let balls = [];
      let selectedPrize = null;
      let drawStatus = 0;
      let latestTitleArea = localStorage.getItem("latestTitleArea");
      let titleArea = document.getElementById("titleArea");
      if (!latestTitleArea) {
        latestTitleArea = titleArea.innerText;
      }
      titleArea.innerText = latestTitleArea;

      const latestPrizeList = localStorage.getItem("latestPrizeList");
      if (latestPrizeList) {
        const targetDiv = document.getElementById("prizeList");
        targetDiv.innerHTML = latestPrizeList;
        const buttons = document.querySelectorAll("#prizeList button");
        buttons.forEach((button) => {
          button.onclick = () => {
            [...prizeList.children].forEach((c) =>
              c.classList.remove("button-selected")
            );
            button.classList.add("button-selected");
            selectedPrize = button;
          };
        });
      }

      const latestBallCount = localStorage.getItem("latestBallCount");
      if (latestBallCount) {
        document.getElementById("ballCount").value = latestBallCount;
        createBalls(+latestBallCount);
      }

      // ê³µ ìƒì„± (ë°œê¸‰ìˆ«ì ì…ë ¥ í›„ ì—”í„°)
      document.getElementById("ballCount").onkeyup = (e) => {
        if (e.key === "Enter") createBalls(+e.target.value);
      };

      // ë°°ì—´ ì„ê¸° (Fisher-Yates ì•Œê³ ë¦¬ì¦˜)
      function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      // ê³µ ìƒì„± í•¨ìˆ˜
      function createBalls(n) {
        balls = shuffle(Array.from({ length: n }, (_, i) => i + 1));

        const ballContainer = document.getElementById("ball_container");
        ballContainer.innerHTML = ""; // ì´ˆê¸°í™” (í•„ìš” ì‹œ)

        const ballsArray = balls.map((item) => {
          const ball = document.createElement("div");
          ball.classList.add("ball");
          ball.textContent = item;
          return ball;
        });

        ballsArray.forEach((ball) => {
          ballContainer.appendChild(ball);
        });

        localStorage.setItem("latestBallCount", n);
        localStorage.setItem("latestBalls", JSON.stringify(balls));
      }

      function preventRefresh(e) {
        // F5 í‚¤ (í‚¤ ì½”ë“œ 116) ë§‰ê¸°
        if (e.keyCode === 116) {
          e.preventDefault();
          alert("ì¶”ì²¨ ì¤‘ ìƒˆë¡œê³ ì¹¨ì´ ì œí•œë©ë‹ˆë‹¤.");
        } else if ((e.ctrlKey || e.metaKey) && e.keyCode === 82) {
          // Ctrl+R í˜¹ì€ Command+R (mac) ë§‰ê¸°
          e.preventDefault();
          alert("ì¶”ì²¨ ì¤‘ ìƒˆë¡œê³ ì¹¨ì´ ì œí•œë©ë‹ˆë‹¤.");
        }
        window.onbeforeunload = function (e) {
          e.preventDefault();
        };
      }

      // ì¶”ì²¨ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      document.getElementById("drawBtn").onclick = () => {
        console.log("drawStatus", drawStatus);
        if (drawStatus > 0)
          return Swal.fire({
            title: "ì¶”ì²¨ì´ ì§„í–‰ì¤‘ ì…ë‹ˆë‹¤.",
            width: "auto",
            padding: "1em",
            heightAuto: false,
            allowOutsideClick: false,
            confirmButtonText: "í™•ì¸",
            customClass: {
              confirmButton: "primary-color", // ì—¬ê¸°ì„œ ì»¤ìŠ¤í…€ í´ë˜ìŠ¤ ì§€ì •
            },
          });
        if (!selectedPrize)
          return Swal.fire({
            title: "ìƒí’ˆì„ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”",
            width: "auto",
            padding: "1em",
            heightAuto: false,
            allowOutsideClick: false,
            confirmButtonText: "í™•ì¸",
            customClass: {
              confirmButton: "primary-color", // ì—¬ê¸°ì„œ ì»¤ìŠ¤í…€ í´ë˜ìŠ¤ ì§€ì •
            },
          });
        if (balls.length === 0)
          return Swal.fire({
            title: "ë°œê¸‰ëœ ë²ˆí˜¸ê°€ ëª¨ë‘ ì‚¬ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.",
            width: "auto",
            padding: "1em",
            heightAuto: false,
            allowOutsideClick: false,
            confirmButtonText: "í™•ì¸",
            customClass: {
              confirmButton: "primary-color", // ì—¬ê¸°ì„œ ì»¤ìŠ¤í…€ í´ë˜ìŠ¤ ì§€ì •
            },
          });
        drawStatus = 1;

        // ìƒˆë¡œê³ ì¹¨ ì œí•œ
        document.addEventListener("keydown", preventRefresh);
        const ballsArray = document.querySelectorAll(".ball");
        let currentIteration = 0;
        // 10ms ê°„ê²©ìœ¼ë¡œ ë¬´í•œ ì§„í–‰ë˜ëŠ” ë¹ ë¥¸ í•˜ì´ë¼ì´íŠ¸ ì• ë‹ˆë©”ì´ì…˜
        let fastInterval = setInterval(() => {
          let highlightIndex = currentIteration % balls.length;

          currentIteration++;

          // div ball ì• ë‹ˆë©”ì´ì…˜
          ballsArray.forEach((ball) => ball.classList.remove("ball_selected"));
          ballsArray[highlightIndex].classList.add("ball_selected");
        }, 30);

        // ì—”í„°í‚¤ ì…ë ¥ ì‹œ ë¹ ë¥¸ ì• ë‹ˆë©”ì´ì…˜ ì¤‘ë‹¨ ë° spinCount ê²°ì • í›„ ëŠë¦° ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
        const enterHandler = (e) => {
          e.preventDefault();
          drawStatus = 2;
          let intervalDuration = 50;
          let highlightIndex;
          if (e.key === "Enter") {
            clearInterval(fastInterval);
            document.removeEventListener("keydown", enterHandler);

            // í™•ë¥  í•¨ìˆ˜ì— ë”°ë¼ ì¶”ê°€ spinCount ê²°ì •
            let getRandom = eval(
              `(${document.getElementById("probabilityFunction").value})`
            );
            let randomIdx = getRandom(balls.length);
            let additionalSpinCount = randomIdx + 1;
            let targetSpinCount = currentIteration + additionalSpinCount;
            console.log("Target spin count:", targetSpinCount);

            // ëŠë ¤ì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜ ë‹¨ê³„ë³„ ì‹¤í–‰ (ì›ë˜ ë¡œì§ê³¼ ë™ì¼)
            // startSecondInterval();

            startAnimation();

            function startAnimation() {
              function animateStep() {
                highlightIndex = currentIteration % balls.length;
                // div ball ì• ë‹ˆë©”ì´ì…˜
                ballsArray.forEach((ball) =>
                  ball.classList.remove("ball_selected")
                );
                ballsArray[highlightIndex].classList.add("ball_selected");

                currentIteration++;
                const gap = targetSpinCount - currentIteration;
                console.log("Interval, remaining:", gap, intervalDuration);
                setIntervalDuration(gap);

                if (currentIteration >= targetSpinCount) {
                  endAnimation();
                  return;
                }

                setTimeout(animateStep, intervalDuration);
              }

              animateStep(); // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            }

            function setIntervalDuration(gap) {
              if (gap <= 1) {
                intervalDuration = 1000;
              } else if (gap <= 2) {
                intervalDuration = 950;
              } else if (gap <= 3) {
                intervalDuration = 900;
              } else if (gap <= 4) {
                intervalDuration = 850;
              } else if (gap <= 5) {
                intervalDuration = 800;
              } else if (gap <= 6) {
                intervalDuration = 750;
              } else if (gap <= 7) {
                intervalDuration = 700;
              } else if (gap <= 8) {
                intervalDuration = 650;
              } else if (gap <= 9) {
                intervalDuration = 600;
              } else if (gap <= 10) {
                intervalDuration = 550;
              } else if (gap <= 12) {
                intervalDuration = 500;
              } else if (gap <= 14) {
                intervalDuration = 450;
              } else if (gap <= 17) {
                intervalDuration = 400;
              } else if (gap <= 20) {
                intervalDuration = 350;
              } else if (gap <= 25) {
                intervalDuration = 300;
              } else if (gap <= 30) {
                intervalDuration = 250;
              } else if (gap <= 40) {
                intervalDuration = 200;
              } else if (gap <= 60) {
                intervalDuration = 150;
              } else if (gap <= 80) {
                intervalDuration = 100;
              } else if (gap <= 100) {
                intervalDuration = 70;
              } else {
                intervalDuration = 50;
              }
            }

            function endAnimation() {
              // ìµœì¢… ë‹¹ì²¨ ê³µ ì²˜ë¦¬
              let winnerBall = ballsArray[highlightIndex];
              winnerBall.active = true;
              setTimeout(() => {
                // div ball ì• ë‹ˆë©”ì´ì…˜
                ballsArray.forEach((ball) =>
                  ball.classList.remove("ball_selected")
                );
                winnerBall.classList.add("ball_completed");
              }, 1000);
              setTimeout(() => {
                drawStatus = 0;
                balls.splice(highlightIndex, 1);

                Swal.fire({
                  title: `${winnerBall.textContent}ë²ˆ`,
                  html: `ğŸ‰ <strong>ì¶•í•˜í•©ë‹ˆë‹¤!</strong> ${selectedPrize.textContent} ë‹¹ì²¨!`,
                  icon: "success",
                  iconHtml: `ğŸ‰`, // ì²´í¬í‘œì‹œ ëŒ€ì‹  ë‹¤ë¥¸ ë¬¸ì ë„£ê¸°
                  width: "auto",
                  padding: "1em",
                  heightAuto: false,
                  allowOutsideClick: false,
                  showConfirmButton: true,
                  confirmButtonText: "í™•ì¸",
                  buttonsStyling: true,
                  customClass: {
                    confirmButton: "primary-color", // ì—¬ê¸°ì„œ ì»¤ìŠ¤í…€ í´ë˜ìŠ¤ ì§€ì •
                  },
                }).then(() => {
                  // ë‹¹ì²¨ëœ ë²ˆí˜¸ëŠ” ballArrayì—ì„œ ì œê±°
                  ballsArray[highlightIndex].remove();
                });

                selectedPrize.textContent += ` - ${winnerBall.textContent}ë²ˆ`;
                // selectedPrize.disabled = true;
                selectedPrize.classList.add("button-outline");
                selectedPrize = null;
                [...prizeList.children].forEach((c) =>
                  c.classList.remove("bg-green-400")
                );
                localStorage.setItem("latestPrizeList", prizeList.innerHTML);
                localStorage.setItem("latestBalls", JSON.stringify(balls));
                document.removeEventListener("keydown", preventRefresh);
              }, 1500);
            }
          }
        };

        document.addEventListener("keydown", enterHandler);
      };

      // ìƒí’ˆ ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸
      document.getElementById("addPrizeBtn").onclick = () => {
        Swal.fire({
          input: "textarea",
          title: "ìƒí’ˆëª…ì„ ì¤„ë°”ê¿ˆìœ¼ë¡œ ì…ë ¥",
          showCancelButton: true,
          width: "auto",
          padding: "1em",
          heightAuto: false,
          allowOutsideClick: false,
          confirmButtonText: "ì¶”ê°€",
          cancelButtonText: "ì·¨ì†Œ",
          customClass: {
            confirmButton: "primary-color", // ì—¬ê¸°ì„œ ì»¤ìŠ¤í…€ í´ë˜ìŠ¤ ì§€ì •
          },
        })
          .then(({ value }) => {
            value?.split("\n").forEach((p) => {
              const el = document.createElement("button");
              el.textContent = p;
              const defaultClass = "button-default ";

              if (p.includes("ì†ìŠ¤íƒ€") || p.includes("í•œì§€ë‹ˆì–´ìŠ¤")) {
                el.className = defaultClass + "special";
              } else {
                el.className = defaultClass;
              }

              el.onclick = () => {
                [...prizeList.children].forEach((c) =>
                  c.classList.remove("button-selected")
                );
                el.classList.add("button-selected");
                selectedPrize = el;
              };
              prizeList.append(el);
            });
          })
          .then((value) => {
            localStorage.setItem("latestPrizeList", prizeList.innerHTML);
          });
      };

      // ë¦¬ì…‹ ë²„íŠ¼ ì´ë²¤íŠ¸
      document.getElementById("resetPrizeBtn").onclick = () => {
        if (confirm("ë¦¬ì…‹ì„ ì§„í–‰í•©ë‹ˆë‹¤") === true) {
          prizeList.innerHTML = "";
          balls = [];
          selectedPrize = null;

          localStorage.removeItem("latestPrizeList");
          localStorage.removeItem("latestBallCount");
          localStorage.removeItem("latestBalls");
        }
      };

      titleArea.addEventListener("blur", (e) => {
        localStorage.setItem("latestTitleArea", titleArea.innerText);
      });
    </script>
  </body>
</html>
