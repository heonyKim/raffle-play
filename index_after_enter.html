<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Í≤ΩÌíà Ï∂îÏ≤®</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
</head>
<body class="flex h-screen overflow-hidden bg-gray-50">
  <!-- ÏôºÏ™Ω ÏòÅÏó≠: ÏÉÅÌíà Î∞è ÏÑ§Ï†ï -->
  <div class="w-1/3 m-7 p-7 overflow-auto items-center justify-center rounded-3xl border-2 border-solid">
    <h2 id="titleArea" contenteditable class="flex items-center text-2xl text-blue-600 font-bold mb-4 cursor-pointer">
      raffle box  Ï†úÎ™© ÏûÖÎ†•
    </h2>
    <div id="prizeList" class="grid grid-cols-2 gap-2"></div>
    <button id="addPrizeBtn" class="px-3 py-1 bg-blue-500 text-white rounded mt-2">+ ÏÉÅÌíà Ï∂îÍ∞Ä</button>
    <button id="resetPrizeBtn" class="px-3 py-1 bg-red-500 text-white rounded mt-2">Î¶¨ÏÖã</button>
    <textarea id="probabilityFunction" class="w-full h-32 border p-2 mt-4">
  function getRandom(numbers){
      return Math.floor(Math.random() * (200 - 100 + 1)) + 100;
  }
          </textarea>
    <input id="ballCount" type="number" class="border p-2 w-full mt-2" placeholder="Î∞úÍ∏âÏà´Ïûê ÏûÖÎ†• ÌõÑ Enter">
    <button id="drawBtn" class="px-4 py-2 bg-orange-500 text-white rounded mt-2">Ï∂îÏ≤®!</button>
  </div>


  <!-- Ïò§Î•∏Ï™Ω ÏòÅÏó≠: Ï∫îÎ≤ÑÏä§ -->
  <div class="w-full h-full flex items-center justify-center">
    <canvas id="myCanvas" width="800" height="300" style="border:1px solid #ccc;"></canvas>
  </div>

  <script type="module">

    const latestPrizeList = localStorage.getItem('latestPrizeList');
    console.log("latestPrizeList",latestPrizeList)
    if (latestPrizeList) {
      const targetDiv = document.getElementById('prizeList');
      targetDiv.innerHTML = latestPrizeList;
      const buttons = document.querySelectorAll("#prizeList button");
      buttons.forEach(button => {

        button.onclick = () => {
          [...prizeList.children].forEach(c => c.classList.remove('bg-green-400'));
          button.classList.add('bg-green-400');
          selectedPrize = button;
        };

      })
    }

    const canvas = document.getElementById('myCanvas');
    const ctx = canvas.getContext('2d');

    class Ball {
      constructor(x, y, radius, color, number) {
        this.x = x;
        this.y = y;
        this.radius = radius;
        this.color = color;
        this.number = number;
      }
      draw(ctx) {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
        ctx.fillStyle = this.color;
        ctx.fill();
        ctx.strokeStyle = "#000";
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.closePath();

        // Ïà´Ïûê ÌëúÏãú
        ctx.fillStyle = "#000";
        ctx.font = "bold 24px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(this.number, this.x, this.y);
      }
    }
    let luckyPrize = null;

    let balls = [];
    let ballNumbers = [];
    let selectedPrize = null;
    let drawStatus = 0;

    // Ï∫îÎ≤ÑÏä§ Ïï†ÎãàÎ©îÏù¥ÏÖò Ìï®Ïàò
    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      balls.forEach(ball => ball.draw(ctx));
      requestAnimationFrame(animate);
    }

    // Í≥µ ÏÉùÏÑ± (Î∞úÍ∏âÏà´Ïûê ÏûÖÎ†• ÌõÑ ÏóîÌÑ∞)
    document.getElementById('ballCount').onkeyup = e => {
      if (e.key === 'Enter') createBalls(+e.target.value);
    };

    // Î∞∞Ïó¥ ÏÑûÍ∏∞ (Fisher-Yates ÏïåÍ≥†Î¶¨Ï¶ò)
    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // Í≥µ ÏÉùÏÑ± Ìï®Ïàò
    function createBalls(n) {
      ballNumbers = Array.from({ length: n }, (_, i) => i + 1);
      const margin = 0;
      const radius = 40;
      const colCount = Math.floor((canvas.width - margin) / (2 * radius + margin));
      const rowCount = Math.ceil(n / colCount);
      canvas.height = margin + rowCount * (2 * radius + margin);

      let positions = [];
      for (let i = 0; i < n; i++) {
        const col = i % colCount;
        const row = Math.floor(i / colCount);
        const x = margin + radius + col * (2 * radius + margin);
        const y = margin + radius + row * (2 * radius + margin);
        positions.push({ x, y });
      }
      positions = shuffle(positions);

      balls = [];
      for (let i = 0; i < n; i++) {
        const pos = positions[i];
        const ball = new Ball(pos.x, pos.y, radius, "white", i + 1);
        balls.push(ball);
      }
      balls.sort((a, b) => (a.y - b.y) || (a.x - b.x));
      animate();
    }

    // Ï∂îÏ≤® Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
    document.getElementById('drawBtn').onclick = () => {
      console.log("drawStatus",drawStatus);
      if(drawStatus > 0) return Swal.fire('Ï∂îÏ≤®Ïù¥ ÏßÑÌñâÏ§ë ÏûÖÎãàÎã§.');
      drawStatus = 1;
      if (!selectedPrize) return Swal.fire('ÏÉÅÌíàÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî');
      if (balls.length === 0) return Swal.fire('Î∞úÍ∏âÎêú Î≤àÌò∏Í∞Ä Î™®Îëê ÏÇ¨Ïö©ÎêòÏóàÏäµÎãàÎã§.');

      let currentIteration = 0;
      // 10ms Í∞ÑÍ≤©ÏúºÎ°ú Î¨¥Ìïú ÏßÑÌñâÎêòÎäî Îπ†Î•∏ ÌïòÏù¥ÎùºÏù¥Ìä∏ Ïï†ÎãàÎ©îÏù¥ÏÖò
      let fastInterval = setInterval(() => {
        balls.forEach(ball => ball.color = "white");
        let highlightIndex = currentIteration % balls.length;
        balls[highlightIndex].color = "yellow";
        currentIteration++;
      }, 10);

      // ÏóîÌÑ∞ÌÇ§ ÏûÖÎ†• Ïãú Îπ†Î•∏ Ïï†ÎãàÎ©îÏù¥ÏÖò Ï§ëÎã® Î∞è spinCount Í≤∞Ï†ï ÌõÑ ÎäêÎ¶∞ Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
      const enterHandler = (e) => {
        e.preventDefault();
        drawStatus = 2;
        if (e.key === 'Enter') {
          clearInterval(fastInterval);
          document.removeEventListener('keydown', enterHandler);

          // ÌôïÎ•† Ìï®ÏàòÏóê Îî∞Îùº Ï∂îÍ∞Ä spinCount Í≤∞Ï†ï
          let getRandom = eval(`(${document.getElementById('probabilityFunction').value})`);
          let randomIdx = getRandom(balls.length);
          let additionalSpinCount = (randomIdx + 1);
          let targetSpinCount = currentIteration + additionalSpinCount;
          console.log("Target spin count:", targetSpinCount);

          // ÎäêÎ†§ÏßÄÎäî Ïï†ÎãàÎ©îÏù¥ÏÖò Îã®Í≥ÑÎ≥Ñ Ïã§Ìñâ (ÏõêÎûò Î°úÏßÅÍ≥º ÎèôÏùº)
          startSecondInterval();

          function startSecondInterval(){
            let secondInterval = setInterval(() => {
              balls.forEach(ball => ball.color = "white");
              let highlightIndex = currentIteration % balls.length;
              balls[highlightIndex].color = "yellow";
              currentIteration++;
              console.log("Second Interval, remaining:", targetSpinCount - currentIteration);
              if(targetSpinCount - currentIteration <= 100){
                clearInterval(secondInterval);
                startThirdInterval();
              }
            }, 50);
          }

          function startThirdInterval(){
            let thirdInterval = setInterval(() => {
              balls.forEach(ball => ball.color = "white");
              let highlightIndex = currentIteration % balls.length;
              balls[highlightIndex].color = "yellow";
              currentIteration++;
              console.log("Third Interval, remaining:", targetSpinCount - currentIteration);
              if(targetSpinCount - currentIteration <= 50){
                clearInterval(thirdInterval);
                startFourthInterval();
              }
            }, 70);
          }

          function startFourthInterval(){
            let forthInterval = setInterval(() => {
              balls.forEach(ball => ball.color = "white");
              let highlightIndex = currentIteration % balls.length;
              balls[highlightIndex].color = "yellow";
              currentIteration++;
              console.log("Fourth Interval, remaining:", targetSpinCount - currentIteration);
              if(targetSpinCount - currentIteration <= 25){
                clearInterval(forthInterval);
                startFifthInterval();
              }
            }, 100);
          }

          function startFifthInterval(){
            let fifthInterval = setInterval(() => {
              balls.forEach(ball => ball.color = "white");
              let highlightIndex = currentIteration % balls.length;
              balls[highlightIndex].color = "yellow";
              currentIteration++;
              console.log("Fifth Interval, remaining:", targetSpinCount - currentIteration);
              if(targetSpinCount - currentIteration <= 7){
                clearInterval(fifthInterval);
                startSixthInterval();
              }
            }, 500);
          }

          function startSixthInterval(){
            let sixthInterval = setInterval(() => {
              balls.forEach(ball => ball.color = "white");
              let highlightIndex = currentIteration % balls.length;
              balls[highlightIndex].color = "yellow";
              currentIteration++;
              console.log("Sixth Interval, remaining:", targetSpinCount - currentIteration);
              if(targetSpinCount - currentIteration <= 4){
                clearInterval(sixthInterval);
                startSeventhInterval();
              }
            }, 700);
          }

          function startSeventhInterval(){
            let seventhInterval = setInterval(() => {
              balls.forEach(ball => ball.color = "white");
              let highlightIndex = currentIteration % balls.length;
              balls[highlightIndex].color = "yellow";
              currentIteration++;
              console.log("Seventh Interval, remaining:", targetSpinCount - currentIteration);
              if(targetSpinCount - currentIteration <= 3){
                clearInterval(seventhInterval);
                startEighthInterval();
              }
            }, 800);
          }

          function startEighthInterval(){
            let eighthInterval = setInterval(() => {
              balls.forEach(ball => ball.color = "white");
              let highlightIndex = currentIteration % balls.length;
              balls[highlightIndex].color = "yellow";
              currentIteration++;
              console.log("Eighth Interval, remaining:", targetSpinCount - currentIteration);
              if (currentIteration >= targetSpinCount) {
                clearInterval(eighthInterval);
                // ÏµúÏ¢Ö ÎãπÏ≤® Í≥µ Ï≤òÎ¶¨
                let winnerBall = balls[highlightIndex];
                winnerBall.active = true;
                setTimeout(() => {
                  balls[highlightIndex].color = "green";
                }, 1000);
                setTimeout(() => {
                  drawStatus = 0;
                  balls.splice(highlightIndex, 1);
                  Swal.fire(`${winnerBall.number}Î≤à`, `üéâÏ∂ïÌïòÌï©ÎãàÎã§! ${selectedPrize.textContent} ÎãπÏ≤®!`, 'success');
                  selectedPrize.textContent += ` - ${winnerBall.number}Î≤à`;
                  selectedPrize.disabled = true;
                  selectedPrize.classList.add('bg-gray-400');
                  selectedPrize = null;
                }, 2000);
              }
            }, 1000);
          }
        }
      };

      document.addEventListener('keydown', enterHandler);
    };

    // ÏÉÅÌíà Ï∂îÍ∞Ä Î≤ÑÌäº Ïù¥Î≤§Ìä∏
    document.getElementById('addPrizeBtn').onclick = () => {
      Swal.fire({
        input: 'textarea',
        title: 'ÏÉÅÌíàÎ™ÖÏùÑ Ï§ÑÎ∞îÍøàÏúºÎ°ú ÏûÖÎ†•',
        showCancelButton: true
      }).then(({ value }) => {
        value?.split('\n').forEach(p => {
          const el = document.createElement('button');
          el.textContent = p;
          if(p.includes('ÏÜêÏä§ÌÉÄ') || p.includes('ÌïúÏßÄÎãàÏñ¥Ïä§')){
            el.className = 'px-2 py-1 bg-sky-200 rounded';
          }else{
            el.className = 'px-2 py-1 bg-gray-200 font-semibold text-gray-600 rounded';
          }

          el.onclick = () => {
            [...prizeList.children].forEach(c => c.classList.remove('bg-green-400'));
            el.classList.add('bg-green-400');
            selectedPrize = el;
          };
          prizeList.append(el);
        });
      }).then(value => {
        localStorage.setItem('latestPrizeList', prizeList.innerHTML);
      });
    };

    // Î¶¨ÏÖã Î≤ÑÌäº Ïù¥Î≤§Ìä∏
    document.getElementById('resetPrizeBtn').onclick = () => {
      prizeList.innerHTML = '';
      selectedPrize = null;
      localStorage.removeItem('latestPrizeList');
    };
  </script>
</body>
</html>
